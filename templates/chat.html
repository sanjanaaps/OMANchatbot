{% extends "base.html" %}

{% block title %}AI Assistant Chat{% endblock %}

{% block main_class %}{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-50">
    <!-- Chat History Sidebar -->
    <div class="w-80 bg-white shadow-lg border-r border-gray-200 flex flex-col hidden lg:flex">
        <!-- Sidebar Header -->
        <div class="p-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fas fa-history text-ocb-blue mr-2"></i>
                Chat History
            </h2>
            <button id="newChatBtn" class="mt-3 w-full bg-ocb-blue text-white px-3 py-2.5 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm">
                <i class="fas fa-plus mr-2"></i>New Chat
            </button>
        </div>
        
        <!-- Tab Navigation -->
        <div class="border-b border-gray-200">
            <div class="flex">
                <button id="todayTab" class="sidebar-tab flex-1 px-4 py-3 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50 border-b-2 border-ocb-blue text-ocb-blue transition-colors">
                    <i class="fas fa-clock mr-2"></i>
                    Today
                </button>
                <button id="historyTab" class="sidebar-tab flex-1 px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-900 hover:bg-gray-50 border-b-2 border-transparent transition-colors">
                    <i class="fas fa-calendar-alt mr-2"></i>
                    History
                </button>
            </div>
        </div>
        
        <!-- Tab Content Container -->
        <div class="flex-1 overflow-y-auto">
            <!-- Today's Chats Tab -->
            <div id="todayContent" class="tab-content p-4 space-y-2">
                <div id="chatHistoryItems">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-comments text-2xl mb-2"></i>
                        <p class="text-sm">No chats today</p>
                    </div>
                </div>
            </div>

            <!-- History Tab (By Day) -->
            <div id="historyContent" class="tab-content hidden">
                <div class="p-4">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Browse by Date</h3>
                    <div id="chatDaysTabs" class="space-y-1">
                        {% if chat_days and chat_days|length > 0 %}
                            {% for d in chat_days %}
                                <button data-day="{{ d }}" class="chat-day-tab w-full text-left px-4 py-3 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 transition-colors flex items-center justify-between group">
                                    <span class="flex items-center">
                                        <i class="fas fa-calendar-day mr-3 text-gray-400 group-hover:text-ocb-blue"></i>
                                        {{ d }}
                                    </span>
                                    <i class="fas fa-chevron-right text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                </button>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-gray-500 py-8">
                                <i class="fas fa-folder-open text-2xl mb-2"></i>
                                <p class="text-sm">No archived chats</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col">
        <!-- Header -->
        <div class="bg-white border-b border-gray-200 px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-comments text-ocb-blue mr-3"></i>
                        AI Assistant Chat
                    </h1>
                    <p class="mt-1 text-gray-600 text-sm">
                        Chat with the AI assistant about your department's documents
                    </p>
                </div>
                <!-- Mobile Menu Button -->
                <button id="mobileMenuBtn" class="lg:hidden inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    <i class="fas fa-history mr-2"></i>
                    History
                </button>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="flex-1 overflow-y-auto p-6 bg-white">
            <div id="chatMessages" class="space-y-6 max-w-5xl mx-auto">
                {% if messages %}
                    {% for message in messages %}
                    <div class="flex {% if message.type == 'user' %}justify-end{% else %}justify-start{% endif %}">
                        <div class="{% if message.type == 'user' %}max-w-[70%]{% else %}max-w-[70%]{% endif %}">
                            {% if message.type == 'assistant' %}
                            <div class="flex items-center mb-2 ml-1">
                                <i class="fas fa-robot text-ocb-blue mr-2"></i>
                                <span class="text-xs font-medium text-gray-600">AI Assistant</span>
                            </div>
                            {% endif %}
                            <div class="px-6 py-4 shadow-md {% if message.type == 'user' %}bg-ocb-blue text-white{% else %}bg-gray-100 text-gray-900{% endif %} relative">
                                {% if message.timestamp %}
                                <div class="text-xs {% if message.type == 'user' %}text-gray-200{% else %}text-gray-500{% endif %} mb-2">
                                    {%- if message.timestamp is string -%}
                                        {%- set hour = message.timestamp[11:13]|int -%}
                                        {%- set display_hour = (hour % 12) if (hour % 12) != 0 else 12 -%}
                                        {{ '%02d'|format(display_hour) }}:{{ message.timestamp[14:16] }} {{ 'PM' if hour >= 12 else 'AM' }}
                                    {%- else -%}
                                        {{ message.timestamp.strftime('%I:%M %p') }}
                                    {%- endif -%}
                                </div>
                                {% endif %}
                                <div class="text-sm prose prose-sm max-w-none {% if message.type == 'user' %}prose-invert{% endif %}">{{ message.content|markdown|safe }}</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center text-gray-500 py-12">
                    <i class="fas fa-comments text-4xl mb-4 text-gray-400"></i>
                    <p class="text-lg">Start a conversation with the AI assistant</p>
                    <p class="text-sm mt-2">Ask questions about your department's documents</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Chat Input Area -->
        <div class="bg-white border-t border-gray-200 p-6 relative">
            <!-- Recording Modal Overlay -->
            <div id="recordingModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center transition-opacity duration-300">
                <!-- Modal Content -->
                <div id="recordingModalContent" class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl mx-4 transform transition-all duration-300">
                    <!-- Modal Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="relative">
                                <i class="fas fa-microphone text-red-600 text-2xl"></i>
                                <span class="absolute -top-1 -right-1 flex h-3 w-3">
                                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                                </span>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900" id="modalStatusText">Recording in Progress</h3>
                                <p class="text-sm text-gray-600 font-mono" id="modalTimer">00:00 / 01:00</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Waveform Display -->
                    <div class="bg-gray-50 rounded-xl p-6 mb-6">
                        <canvas id="waveformCanvas" width="600" height="120" 
                                class="w-full" 
                                style="height: 120px;"></canvas>
                    </div>
                    
                    <!-- Stop Recording Button -->
                    <button type="button" id="stopRecordingBtn" onclick="stopRecording()" 
                            class="w-full inline-flex items-center justify-center px-6 py-4 border border-transparent text-base font-semibold rounded-xl text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all duration-200 shadow-lg hover:shadow-xl">
                        <i class="fas fa-stop mr-3 text-xl"></i>
                        Stop Recording
                    </button>
                    
                    <!-- Processing State (hidden by default) -->
                    <div id="processingState" class="hidden text-center">
                        <div class="inline-flex items-center space-x-3 px-6 py-3 bg-blue-50 rounded-xl">
                            <i class="fas fa-spinner fa-spin text-blue-600 text-xl"></i>
                            <span class="text-base font-medium text-blue-900">Processing your recording...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <form method="POST" id="chatForm" class="max-w-4xl mx-auto space-y-4 relative" style="z-index: 10;">
                <!-- File Upload Area -->
                <div id="fileUploadArea" class="hidden">
                    <div class="border border-gray-300 border-dashed rounded-lg p-4 transition-all duration-300">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-file text-gray-400"></i>
                                <span class="text-sm text-gray-600" id="uploadedFileName">No file selected</span>
                            </div>
                            <button type="button" id="removeFileBtn" class="text-red-500 hover:text-red-700 text-sm transition-colors">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="flex items-end space-x-3">
                    <!-- Upload Button -->
                    <button type="button" id="uploadBtn" class="flex-shrink-0 inline-flex items-center justify-center w-11 h-11 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 shadow-sm relative" style="z-index: 60;">
                        <i class="fas fa-paperclip text-lg"></i>
                    </button>
                    <input type="file" id="fileInput" accept=".pdf,.docx,.doc,.png,.jpg,.jpeg,.tiff" class="hidden">
                    
                    <!-- Record Button (Start Recording) -->
                    <button type="button" id="recordBtn" onclick="startRecording()" 
                            class="flex-shrink-0 inline-flex items-center justify-center w-11 h-11 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 shadow-sm relative" style="z-index: 60;">
                        <i class="fas fa-microphone text-lg text-red-600" id="recordIcon"></i>
                    </button>
                    
                    <!-- Message Input -->
                    <div class="flex-1 relative">
                        <label for="message" class="sr-only">Message</label>
                        <textarea name="message" id="message" rows="3" 
                                  class="shadow-sm focus:ring-2 focus:ring-ocb-blue focus:border-ocb-blue block w-full text-sm border-gray-300 rounded-lg resize-none transition-all duration-200 pr-3 py-3 px-4"
                                  placeholder="Ask a question about your department's documents..."
                                  required></textarea>
                    </div>
                    
                    <!-- Language and Send -->
                    <div class="flex flex-col space-y-2">
                        <select name="language" id="language" class="block w-24 pl-3 pr-8 py-2.5 text-sm border-gray-300 focus:outline-none focus:ring-2 focus:ring-ocb-blue focus:border-ocb-blue rounded-lg transition-all duration-200 shadow-sm">
                            <option value="en">EN</option>
                            <option value="ar">AR</option>
                        </select>
                        <button type="submit" class="inline-flex items-center justify-center px-5 py-2.5 border border-transparent text-sm font-medium rounded-lg text-white bg-ocb-blue hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-ocb-blue transition-all duration-200 shadow-sm hover:shadow-md">
                            <i class="fas fa-paper-plane mr-2"></i>
                            Send
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include browser audio processor as fallback -->
<script src="{{ url_for('static', filename='browser_audio_processor.js') }}"></script>
<!-- Include markdown parser for dynamic content -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
(function() {
    'use strict';
    
    // Elements
    const recordBtn = document.getElementById('recordBtn');
    const recordIcon = document.getElementById('recordIcon');
    const recordingModal = document.getElementById('recordingModal');
    const recordingModalContent = document.getElementById('recordingModalContent');
    const modalTimer = document.getElementById('modalTimer');
    const modalStatusText = document.getElementById('modalStatusText');
    const stopRecordingBtn = document.getElementById('stopRecordingBtn');
    const processingState = document.getElementById('processingState');
    const canvas = document.getElementById('waveformCanvas');
    const messageTextarea = document.getElementById('message');
    
    // UI elements
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');
    const fileUploadArea = document.getElementById('fileUploadArea');
    const uploadedFileName = document.getElementById('uploadedFileName');
    const removeFileBtn = document.getElementById('removeFileBtn');
    const newChatBtn = document.getElementById('newChatBtn');
    const chatHistoryList = document.getElementById('chatHistoryList');
    
    // Tab elements
    const todayTab = document.getElementById('todayTab');
    const historyTab = document.getElementById('historyTab');
    const todayContent = document.getElementById('todayContent');
    const historyContent = document.getElementById('historyContent');
    
    // Tab switching functionality
    function switchTab(tabName) {
        const tabs = document.querySelectorAll('.sidebar-tab');
        const contents = document.querySelectorAll('.tab-content');
        
        tabs.forEach(tab => {
            tab.classList.remove('border-ocb-blue', 'text-ocb-blue');
            tab.classList.add('border-transparent', 'text-gray-500');
        });
        
        contents.forEach(content => {
            content.classList.add('hidden');
        });
        
        if (tabName === 'today') {
            todayTab.classList.remove('border-transparent', 'text-gray-500');
            todayTab.classList.add('border-ocb-blue', 'text-ocb-blue');
            todayContent.classList.remove('hidden');
        } else if (tabName === 'history') {
            historyTab.classList.remove('border-transparent', 'text-gray-500');
            historyTab.classList.add('border-ocb-blue', 'text-ocb-blue');
            historyContent.classList.remove('hidden');
        }
    }
    
    todayTab.addEventListener('click', () => switchTab('today'));
    historyTab.addEventListener('click', () => switchTab('history'));
    
    // File upload functionality
    let selectedFile = null;
    
    uploadBtn.addEventListener('click', () => {
        fileInput.click();
    });
    
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            selectedFile = file;
            uploadedFileName.textContent = file.name;
            fileUploadArea.classList.remove('hidden');
        }
    });
    
    removeFileBtn.addEventListener('click', () => {
        selectedFile = null;
        fileInput.value = '';
        fileUploadArea.classList.add('hidden');
        uploadedFileName.textContent = 'No file selected';
    });
    
    // New chat functionality
    newChatBtn.addEventListener('click', async () => {
        try {
            // Call API to start new chat session
            const response = await fetch('/api/new-chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                // Clear current chat display
                document.getElementById('chatMessages').innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <i class="fas fa-comments text-4xl mb-4"></i>
                        <p class="text-lg">Start a conversation with the AI assistant</p>
                        <p class="text-sm mt-2">Ask questions about your department's documents</p>
                    </div>
                `;
                
                // Clear message input
                messageTextarea.value = '';
                
                // Remove selected file
                removeFileBtn.click();
                
                // Switch to today tab and load updated chat history
                switchTab('today');
                loadChatHistory();
            } else {
                console.error('Failed to start new chat session');
            }
        } catch (error) {
            console.error('Error starting new chat:', error);
        }
    });
    
    // Load chat history
    function loadChatHistory() {
        fetch('/api/chat-history')
            .then(response => response.json())
            .then(data => {
                const chatHistoryItems = document.getElementById('chatHistoryItems');
                if (!chatHistoryItems) return;

                if (data.success && data.chats.length > 0) {
                    chatHistoryItems.innerHTML = '';
                    data.chats.forEach(chat => {
                        const chatItem = document.createElement('div');
                        chatItem.className = 'p-3 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors group';
                        chatItem.innerHTML = `
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium text-gray-900 truncate group-hover:text-ocb-blue">${chat.summary || 'Untitled Chat'}</div>
                                    <div class="text-xs text-gray-500 mt-1">${new Date(chat.timestamp).toLocaleDateString()}</div>
                                </div>
                                <i class="fas fa-chevron-right text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity ml-2"></i>
                            </div>
                        `;
                        chatItem.addEventListener('click', () => loadChat(chat.id));
                        chatHistoryItems.appendChild(chatItem);
                    });
                } else {
                    chatHistoryItems.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-comments text-2xl mb-2"></i>
                            <p class="text-sm">No chats today</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading chat history:', error);
            });
    }
    
    // Load specific chat
    function loadChat(chatId) {
        fetch(`/api/chat-history/${chatId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.innerHTML = '';
                    
                    if (data.messages.length > 0) {
                        data.messages.forEach(message => {
                            const messageDiv = document.createElement('div');
                            messageDiv.className = `flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`;
                            
                            const bubbleDiv = document.createElement('div');
                            bubbleDiv.className = message.type === 'user' ? 'max-w-[70%]' : 'max-w-[70%]';
                            
                            if (message.type === 'assistant') {
                                const labelDiv = document.createElement('div');
                                labelDiv.className = 'flex items-center mb-2 ml-1';
                                labelDiv.innerHTML = `
                                    <i class="fas fa-robot text-ocb-blue mr-2"></i>
                                    <span class="text-xs font-medium text-gray-600">AI Assistant</span>
                                `;
                                bubbleDiv.appendChild(labelDiv);
                            }
                            
                            const contentDiv = document.createElement('div');
                            contentDiv.className = `px-6 py-4 shadow-md ${message.type === 'user' ? 'bg-ocb-blue text-white' : 'bg-gray-100 text-gray-900'}`;
                            
                            let timeStr = '';
                            if (message.timestamp) {
                                if (typeof message.timestamp === 'string') {
                                    const hours = parseInt(message.timestamp.substring(11, 13));
                                    const minutes = message.timestamp.substring(14, 16);
                                    const ampm = hours >= 12 ? 'PM' : 'AM';
                                    const displayHours = hours % 12 || 12;
                                    timeStr = `${String(displayHours).padStart(2, '0')}:${minutes} ${ampm}`;
                                } else {
                                    const time = new Date(message.timestamp);
                                    timeStr = time.toLocaleString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                                }
                            }
                            
                            contentDiv.innerHTML = `
                                ${timeStr ? `<div class="text-xs ${message.type === 'user' ? 'text-gray-200' : 'text-gray-500'} mb-2">${timeStr}</div>` : ''}
                                <div class="text-sm prose prose-sm max-w-none ${message.type === 'user' ? 'prose-invert' : ''}">${marked.parse(message.content)}</div>
                            `;
                            
                            bubbleDiv.appendChild(contentDiv);
                            messageDiv.appendChild(bubbleDiv);
                            messagesContainer.appendChild(messageDiv);
                        });
                    } else {
                        messagesContainer.innerHTML = `
                            <div class="text-center text-gray-500 py-12">
                                <i class="fas fa-comments text-4xl mb-4 text-gray-400"></i>
                                <p class="text-lg">Start a conversation with the AI assistant</p>
                                <p class="text-sm mt-2">Ask questions about your department's documents</p>
                            </div>
                        `;
                    }
                    
                    // Scroll to bottom
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            })
            .catch(error => {
                console.error('Error loading chat:', error);
            });
    }
    
    // Load chat history on page load
    loadChatHistory();
    
    // Mobile menu functionality
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const sidebar = document.querySelector('.w-80');
    
    if (mobileMenuBtn && sidebar) {
        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('absolute');
            sidebar.classList.toggle('z-50');
            sidebar.classList.toggle('lg:flex');
        });
    }

    // ---------------- Day-tabs for archived chat messages ----------------
    const chatDaysTabsContainer = document.getElementById('chatDaysTabs');

    // Event delegation: handle clicks on any .chat-day-tab
    if (chatDaysTabsContainer) {
        chatDaysTabsContainer.addEventListener('click', (evt) => {
            const btn = evt.target.closest('.chat-day-tab');
            if (!btn) return;
            const day = btn.dataset.day;
            if (!day) return;
            console.info('[chat] day tab clicked:', day);
            try {
                loadArchivedDay(day, btn);
            } catch (err) {
                console.error('[chat] error invoking loadArchivedDay:', err);
            }
        });
    }

    // Helper: fetch and render chat days from the API
    async function fetchAndRenderChatDays() {
        try {
            const res = await fetch('/api/chat-days');
            if (!res.ok) throw new Error('Failed to fetch chat days');
            const data = await res.json();
            if (!data.success) throw new Error(data.error || 'API error');

            if (chatDaysTabsContainer) chatDaysTabsContainer.innerHTML = '';

            if (data.days && data.days.length > 0) {
                data.days.forEach(day => {
                    const btn = document.createElement('button');
                    btn.className = 'chat-day-tab w-full text-left px-4 py-3 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 transition-colors flex items-center justify-between group';
                    btn.dataset.day = day;
                    btn.innerHTML = `
                        <span class="flex items-center">
                            <i class="fas fa-calendar-day mr-3 text-gray-400 group-hover:text-ocb-blue"></i>
                            ${day}
                        </span>
                        <i class="fas fa-chevron-right text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                    `;
                    chatDaysTabsContainer.appendChild(btn);
                });
            } else {
                if (chatDaysTabsContainer) {
                    chatDaysTabsContainer.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-folder-open text-2xl mb-2"></i>
                            <p class="text-sm">No archived chats</p>
                        </div>
                    `;
                }
            }
        } catch (err) {
            console.error('Error fetching chat days:', err);
            if (chatDaysTabsContainer) {
                chatDaysTabsContainer.innerHTML = '<div class="text-sm text-red-500 px-4 py-2">Failed to load chat days</div>';
            }
        }
    }

    // Load messages for an archived day
    async function loadArchivedDay(day, btn) {
        try {
            // Visual feedback
            document.querySelectorAll('.chat-day-tab').forEach(b => {
                b.classList.remove('bg-ocb-blue', 'text-white');
                b.classList.add('text-gray-700');
            });
            if (btn) {
                btn.classList.remove('text-gray-700');
                btn.classList.add('bg-ocb-blue', 'text-white');
            }

            const res = await fetch(`/api/chat-day/${day}`);
            if (!res.ok) throw new Error('Failed to fetch messages for day: ' + day);
            const data = await res.json();
            if (!data.success) throw new Error(data.error || 'API error');

            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';

            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`;

                    const bubbleDiv = document.createElement('div');
                    bubbleDiv.className = message.type === 'user' ? 'max-w-[70%]' : 'max-w-[70%]';

                    if (message.type === 'assistant') {
                        const labelDiv = document.createElement('div');
                        labelDiv.className = 'flex items-center mb-2 ml-1';
                        labelDiv.innerHTML = `
                            <i class="fas fa-robot text-ocb-blue mr-2"></i>
                            <span class="text-xs font-medium text-gray-600">AI Assistant</span>
                        `;
                        bubbleDiv.appendChild(labelDiv);
                    }

                    const contentDiv = document.createElement('div');
                    contentDiv.className = `px-6 py-4 shadow-md ${message.type === 'user' ? 'bg-ocb-blue text-white' : 'bg-gray-100 text-gray-900'}`;

                    let timeStr = '';
                    if (message.timestamp) {
                        const hours = parseInt(message.timestamp.substring(11, 13));
                        const minutes = message.timestamp.substring(14, 16);
                        const ampm = hours >= 12 ? 'PM' : 'AM';
                        const displayHours = hours % 12 || 12;
                        timeStr = `${String(displayHours).padStart(2, '0')}:${minutes} ${ampm}`;
                    }

                    contentDiv.innerHTML = `
                        ${timeStr ? `<div class="text-xs ${message.type === 'user' ? 'text-gray-200' : 'text-gray-500'} mb-2">${timeStr}</div>` : ''}
                        <div class="text-sm prose prose-sm max-w-none ${message.type === 'user' ? 'prose-invert' : ''}">${marked.parse(message.content)}</div>
                    `;

                    bubbleDiv.appendChild(contentDiv);
                    messageDiv.appendChild(bubbleDiv);
                    messagesContainer.appendChild(messageDiv);
                });
            } else {
                messagesContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <i class="fas fa-comments text-4xl mb-4 text-gray-400"></i>
                        <p class="text-lg">No messages for ${day}</p>
                    </div>
                `;
            }

            messagesContainer.scrollTop = 0;
            console.info(`Loaded ${data.messages.length} messages for day ${day}`);
        } catch (err) {
            console.error('Error loading archived day:', err);
        }
    }

    // Initially fetch and render chat days
    fetchAndRenderChatDays();
    
    // Handle form submission with file upload
    document.getElementById('chatForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = messageTextarea.value.trim();
        const language = document.getElementById('language').value;
        if (!message && !selectedFile) {
            alert('Please enter a message or upload a file');
            return;
        }
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
        submitBtn.disabled = true;
        
        try {
            const formData = new FormData();
            formData.append('message', message);
            formData.append('language', language);
            if (selectedFile) {
                formData.append('file', selectedFile);
            }
            
            const response = await fetch('/chat', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                fetch('/api/chat-history/current')
                    .then(res => res.json())
                    .then(data => {
                        if (data.success && data.messages) {
                            const messagesContainer = document.getElementById('chatMessages');
                            messagesContainer.innerHTML = '';
                            
                            if (data.messages.length > 0) {
                                data.messages.forEach(message => {
                                    const messageDiv = document.createElement('div');
                                    messageDiv.className = `flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`;
                                    
                                    const bubbleDiv = document.createElement('div');
                                    bubbleDiv.className = 'max-w-[70%]';
                                    
                                    if (message.type === 'assistant') {
                                        const labelDiv = document.createElement('div');
                                        labelDiv.className = 'flex items-center mb-2 ml-1';
                                        labelDiv.innerHTML = `
                                            <i class="fas fa-robot text-ocb-blue mr-2"></i>
                                            <span class="text-xs font-medium text-gray-600">AI Assistant</span>
                                        `;
                                        bubbleDiv.appendChild(labelDiv);
                                    }
                                    
                                    const contentDiv = document.createElement('div');
                                    contentDiv.className = `px-6 py-4 shadow-md ${message.type === 'user' ? 'bg-ocb-blue text-white' : 'bg-gray-100 text-gray-900'} relative`;
                                    
                                    let timeStr = '';
                                    if (message.timestamp) {
                                        if (typeof message.timestamp === 'string') {
                                            const hours = parseInt(message.timestamp.substring(11, 13));
                                            const minutes = message.timestamp.substring(14, 16);
                                            const ampm = hours >= 12 ? 'PM' : 'AM';
                                            const displayHours = hours % 12 || 12;
                                            timeStr = `${String(displayHours).padStart(2, '0')}:${minutes} ${ampm}`;
                                        } else {
                                            const time = new Date(message.timestamp);
                                            timeStr = time.toLocaleString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                                        }
                                    }
                                    
                                    contentDiv.innerHTML = `
                                        ${timeStr ? `<div class="text-xs ${message.type === 'user' ? 'text-gray-200' : 'text-gray-500'} mb-2">${timeStr}</div>` : ''}
                                        <div class="text-sm prose prose-sm max-w-none ${message.type === 'user' ? 'prose-invert' : ''}">${marked.parse(message.content)}</div>
                                    `;
                                    
                                    bubbleDiv.appendChild(contentDiv);
                                    messageDiv.appendChild(bubbleDiv);
                                    messagesContainer.appendChild(messageDiv);
                                });
                            } else {
                                messagesContainer.innerHTML = `
                                    <div class="text-center text-gray-500 py-12">
                                        <i class="fas fa-comments text-4xl mb-4 text-gray-400"></i>
                                        <p class="text-lg">Start a conversation with the AI assistant</p>
                                        <p class="text-sm mt-2">Ask questions about your department's documents</p>
                                    </div>
                                `;
                            }
                            
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            messageTextarea.value = '';
                            removeFileBtn.click();
                            
                            // Refresh chat history after sending message
                            loadChatHistory();
                        }
                    })
                    .catch(error => {
                        console.error('Error updating chat messages:', error);
                    });
            } else {
                throw new Error('Failed to send message');
            }
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Failed to send message. Please try again.');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
    
    // Initialize fallback audio processor
    let fallbackProcessor = null;
    let whisperHandler = null;
    
    try {
        if (window.AudioProcessor && window.WhisperAudioHandler) {
            fallbackProcessor = new window.AudioProcessor();
            whisperHandler = new window.WhisperAudioHandler();
            console.log('[voice] Fallback audio processor initialized');
        } else {
            console.warn('[voice] Fallback audio processor not available');
        }
    } catch (error) {
        console.error('[voice] Failed to initialize fallback audio processor:', error);
    }

    window.startRecording = async function() {
        console.warn('[voice] startRecording called before initialization');
    };
    
    window.stopRecording = async function() {
        console.warn('[voice] stopRecording called before initialization');
    };

    if (!recordBtn || !modalTimer || !canvas) {
        console.error('[voice] Required elements not found');
        return;
    }

    const canvasCtx = canvas.getContext('2d');
    let isRecording = false;
    let startTime = 0;
    let timerInterval = null;
    let rafId = null;

    let mediaStream = null;
    let mediaRecorder = null;
    let audioContext = null;
    let analyser = null;
    let source = null;
    let dataArray = null;
    let bufferLength = 0;

    let voiceSessionId = null;
    let recordedChunks = [];

    function formatTime(ms) {
        const totalSec = Math.min(60, Math.floor(ms / 1000));
        const mm = String(Math.floor(totalSec / 60)).padStart(2, '0');
        const ss = String(totalSec % 60).padStart(2, '0');
        return `${mm}:${ss} / 01:00`;
    }

    function clearCanvas() {
        if (!canvasCtx) return;
        canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
        canvasCtx.fillStyle = '#f9fafb';
        canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function resizeCanvas() {
        const dpr = window.devicePixelRatio || 1;
        canvas.width = Math.floor(600 * dpr);
        canvas.height = Math.floor(120 * dpr);
        canvasCtx.setTransform(1, 0, 0, 1, 0, 0);
        canvasCtx.scale(dpr, dpr);
        clearCanvas();
    }

    function drawWaveform() {
        if (!analyser || !dataArray || !isRecording) return;
        
        try {
            analyser.getByteTimeDomainData(dataArray);
            const width = 600;
            const height = 120;

            canvasCtx.fillStyle = '#f9fafb';
            canvasCtx.fillRect(0, 0, width, height);
            canvasCtx.lineWidth = 2.5;
            canvasCtx.strokeStyle = '#dc2626';
            canvasCtx.beginPath();

            const sliceWidth = width / bufferLength;
            let x = 0;
            const centerY = height / 2;

            for (let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0;
                const y = centerY + ((v - 1) * centerY * 0.8);

                if (i === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }

                x += sliceWidth;
            }

            canvasCtx.lineTo(width, centerY);
            canvasCtx.stroke();
            rafId = requestAnimationFrame(drawWaveform);
        } catch (error) {
            console.error('[voice] Waveform drawing error:', error);
        }
    }

    function showRecordingModal() {
        recordingModal.classList.remove('hidden');
        stopRecordingBtn.classList.remove('hidden');
        processingState.classList.add('hidden');
        recordingModalContent.style.transform = 'scale(0.95)';
        recordingModal.style.opacity = '0';
        setTimeout(() => {
            recordingModal.style.opacity = '1';
            recordingModalContent.style.transform = 'scale(1)';
        }, 10);
    }

    function hideRecordingModal() {
        recordingModal.style.opacity = '0';
        recordingModalContent.style.transform = 'scale(0.95)';
        setTimeout(() => {
            recordingModal.classList.add('hidden');
        }, 300);
    }

    function updateModalStatus(status) {
        modalStatusText.textContent = status;
        if (status === 'Processing your recording...') {
            stopRecordingBtn.classList.add('hidden');
            processingState.classList.remove('hidden');
        } else if (status === 'Complete') {
            stopRecordingBtn.classList.add('hidden');
            processingState.classList.add('hidden');
        }
    }

    async function startRecording() {
        try {
            updateModalStatus('Starting...');
            showRecordingModal();
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error('Microphone access not supported by this browser');
            }

            try {
                const res = await fetch('/voice/start', { method: 'POST' });
                if (res.ok) {
                    const data = await res.json();
                    voiceSessionId = data.session_id;
                }
            } catch (error) {
                console.log('[voice] session start not available:', error);
            }

            mediaStream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });

            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }

            analyser = audioContext.createAnalyser();
            source = audioContext.createMediaStreamSource(mediaStream);
            source.connect(analyser);
            analyser.fftSize = 2048;
            bufferLength = analyser.fftSize;
            dataArray = new Uint8Array(bufferLength);

            const options = {};
            if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                options.mimeType = 'audio/webm;codecs=opus';
            } else if (MediaRecorder.isTypeSupported('audio/webm')) {
                options.mimeType = 'audio/webm';
            }

            try {
                mediaRecorder = new MediaRecorder(mediaStream, options);
            } catch (e) {
                mediaRecorder = new MediaRecorder(mediaStream);
            }
            recordedChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                if (event.data && event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.start();
            isRecording = true;
            startTime = Date.now();
            updateModalStatus('Recording in Progress');
            resizeCanvas();
            drawWaveform();

            timerInterval = setInterval(async () => {
                const elapsed = Date.now() - startTime;
                modalTimer.textContent = formatTime(elapsed);
                if (elapsed >= 60000) {
                    await stopRecording();
                }
            }, 100);

        } catch (error) {
            console.error('[voice] Failed to start recording:', error);
            updateModalStatus(`Error: ${error.message}`);
            await cleanup();
            hideRecordingModal();
        }
    }

    async function stopRecording() {
        if (!isRecording) return;
        isRecording = false;
        updateModalStatus('Processing your recording...');

        try {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                await new Promise((resolve) => {
                    mediaRecorder.onstop = resolve;
                    mediaRecorder.stop();
                });
            }

            try {
                if (!recordedChunks || recordedChunks.length === 0) {
                    throw new Error('no audio captured');
                }
                
                let transcriptionSuccess = false;
                try {
                    let chosenMime = (mediaRecorder && mediaRecorder.mimeType) ? mediaRecorder.mimeType : 'audio/webm';
                    let ext = 'webm';
                    if (chosenMime.includes('wav')) ext = 'wav';
                    else if (chosenMime.includes('webm')) ext = 'webm';
                    else if (chosenMime.includes('ogg')) ext = 'ogg';
                    
                    const originalBlob = new Blob(recordedChunks, { type: chosenMime });
                    let wavBuffer = null;
                    
                    if (fallbackProcessor) {
                        try {
                            const conv = await fallbackProcessor.blobToWhisperFormat(originalBlob);
                            if (conv && conv.success && conv.audioData) {
                                wavBuffer = conv.audioData;
                                ext = 'wav';
                                chosenMime = 'audio/wav';
                            }
                        } catch (ce) {
                            console.warn('[voice] In-browser WAV conversion failed', ce);
                        }
                    }

                    const uploadBlob = wavBuffer ? new Blob([wavBuffer], { type: 'audio/wav' }) : originalBlob;
                    const sr = audioContext ? audioContext.sampleRate : '';
                    const formData = new FormData();
                    formData.append('sample_rate_hz', String(sr));
                    formData.append('audio', uploadBlob, `recording.${ext}`);
                    
                    const response = await fetch('/voice/transcribe', { method: 'POST', body: formData });
                    if (response.ok) {
                        const result = await response.json();
                        if (result.transcript) {
                            messageTextarea.value = result.transcript;
                            transcriptionSuccess = true;
                        }
                    }
                } catch (primaryError) {
                    console.error('[voice] Primary transcription failed:', primaryError);
                }
                
                if (!transcriptionSuccess && fallbackProcessor && whisperHandler) {
                    try {
                        const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                        const result = await whisperHandler.processRecordedAudio(blob);
                        if (result.success && result.transcript) {
                            messageTextarea.value = result.transcript;
                            transcriptionSuccess = true;
                        }
                    } catch (fallbackError) {
                        console.error('[voice] Fallback transcription error:', fallbackError);
                    }
                }
                
                if (!transcriptionSuccess) {
                    updateModalStatus('Transcription failed - try again');
                } else {
                    updateModalStatus('Complete');
                }
                
            } catch (err) {
                console.error('[voice] Audio processing error:', err);
                updateModalStatus('Processing failed');
            }

            await cleanup();
            setTimeout(() => {
                hideRecordingModal();
            }, 1500);

        } catch (error) {
            console.error('Error stopping recording:', error);
            updateModalStatus('Error stopping recording');
            setTimeout(() => {
                hideRecordingModal();
            }, 2000);
        }
    }

    async function cleanup() {
        if (rafId) {
            cancelAnimationFrame(rafId);
            rafId = null;
        }
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        if (mediaStream) {
            mediaStream.getTracks().forEach(track => track.stop());
            mediaStream = null;
        }
        if (audioContext && audioContext.state !== 'closed') {
            try {
                await audioContext.close();
            } catch (error) {
                console.error('[voice] Error closing audio context:', error);
            }
            audioContext = null;
        }
        modalTimer.textContent = '00:00 / 01:00';
        clearCanvas();
        analyser = null;
        source = null;
        dataArray = null;
        mediaRecorder = null;
    }

    window.startRecording = startRecording;
    window.stopRecording = stopRecording;
    resizeCanvas();

})();
</script>
{% endblock %}